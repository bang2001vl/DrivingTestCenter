datasource db {
    url      = "mysql://sa:HackDuocThi%21%40%23NhatBanRoi%24%25%5E@localhost:3306/doan2"
    provider = "mysql"
}

generator client {
    provider = "prisma-client-js"
}

//
// Account system
//
model Account {
    id     Int @id @default(autoincrement())
    roleId Int

    username String @db.VarChar(256)
    password String @db.VarChar(256)
    status   Int    @default(0)

    createdAt DateTime @default(now()) @db.DateTime(0)
    updatedAt DateTime @default(now()) @db.DateTime(0)

    session  Session[]
    employee Employee?
    student  Student?

    @@index([username, password])
    @@map("account")
}

model Session {
    id        Int @id @default(autoincrement())
    accountId Int

    token       String @unique(map: "token") @db.VarChar(50)
    deviceInfo  String @db.VarChar(5000)
    sessionData String @db.VarChar(5000)

    createdAt DateTime @default(now()) @db.DateTime(0)
    updatedAt DateTime @default(now()) @db.DateTime(0)

    account Account @relation(fields: [accountId], references: [id], map: "session_ibfk_1")

    @@index([accountId])
    @@map("session")
}

model CONST_ROLE {
    id   Int    @id @default(autoincrement())
    name String @db.VarChar(255)

    @@map("const_role")
}

//
// Data system
//
model Exam {
    id Int @id @default(autoincrement())

    name      String   @db.VarChar(255)
    type      String   @db.VarChar(255)
    dateStart DateTime
    dateEnd   DateTime
    dateOpen  DateTime
    dateClose DateTime
    maxMember Int
    rules     String   @db.VarChar(3000)
    price     Int

    countStudent Int      @default(0)
    createdAt    DateTime @default(now())
    updatedAt    DateTime @updatedAt

    examTests ExamTest[]
    classes   Class[]
    @@map("exam")
}

model ExamTest {
    id     Int  @id @default(autoincrement())
    examId Int?

    name          String   @db.VarChar(255)
    location      String   @db.VarChar(255)
    dateTimeStart DateTime
    dateTimeEnd   DateTime
    maxMember     Int

    countStudent Int      @default(0)
    createdAt    DateTime @default(now())
    updatedAt    DateTime @updatedAt

    exam         Exam?                    @relation(fields: [examId], references: [id])
    studentCNNs  CONN_Student_ExamTest[]
    employeeCNNs CONN_Employee_ExamTest[]
    bills Bill[]
    @@map("examtest")
}

model Class {
    id     Int  @id @default(autoincrement())
    examId Int?

    name      String   @db.VarChar(255)
    location  String   @db.VarChar(255)
    dateStart DateTime
    dateEnd   DateTime
    maxMember Int
    rules     String   @db.VarChar(3000)
    price     Int

    countStudent Int      @default(0)
    createdAt    DateTime @default(now())
    updatedAt    DateTime @updatedAt

    exam         Exam?                 @relation(fields: [examId], references: [id])
    schedules    ClassSchedule[]
    studentCNNs  CONN_Student_Class[]
    employeeCNNs CONN_Employee_Class[]
    bills   Bill[]
    @@map("class")
}

model ClassSchedule {
    id      Int  @id @default(autoincrement())
    classId Int?

    location  String   @db.VarChar(255)
    dateStart DateTime
    dateEnd   DateTime
    notes     String?   @db.VarChar(3000)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    classes Class? @relation(fields: [classId], references: [id])
    @@map("classschedule")
}

model Student {
    id        Int @id @default(autoincrement())
    accountId Int @unique

    fullname  String   @db.VarChar(255)
    birthday  DateTime
    gender    Int
    email   String @db.VarChar(256)
    phoneNumber String  @db.VarChar(20)
    address   String   @db.VarChar(1000)
    avatarURI String?  @db.VarChar(256)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    account      Account                 @relation(fields: [accountId], references: [id])
    bills     Bill[]
    classCNNs    CONN_Student_Class[]
    examTestCNNs CONN_Student_ExamTest[]
    @@map("student")
}

model Employee {
    id        Int @id @default(autoincrement())
    accountId Int @unique

    fullname  String   @db.VarChar(255)
    birthday  DateTime
    gender    Int
    address   String   @db.VarChar(1000)
    avatarURI String?  @db.VarChar(256)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    account      Account                  @relation(fields: [accountId], references: [id])
    classCNNs    CONN_Employee_Class[]
    examTestCNNs CONN_Employee_ExamTest[]
    @@map("employee")
}

model Bill {
    id        Int  @id @default(autoincrement())
    depositorId Int
    recipientId  Int

    totalPrice Int
    reason     String @db.VarChar(255)
    status     Int    @default(0)
    notes String? @db.VarChar(3000)

    beginAt DateTime @default(now())
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    depositorStudent Student?     @relation(fields: [depositorId], references: [id])
    recipientClass Class?     @relation(fields: [recipientId], references: [id], map: "fk_bill_class")
    recipientExamTest ExamTest?     @relation(fields: [recipientId], references: [id], map: "fk_bill_examtest")
    @@map("payment")
}

model CONN_Student_ExamTest {
    id           Int @id @default(autoincrement())
    studentId    Int
    examTestId   Int
    billDetailId Int @unique

    examTest   ExamTest   @relation(fields: [examTestId], references: [id])
    student    Student    @relation(fields: [studentId], references: [id])
    @@map("conn_student_examtest")
}

model CONN_Student_Class {
    id           Int @id @default(autoincrement())
    studentId    Int
    classId      Int
    billDetailId Int @unique

    student    Student    @relation(fields: [studentId], references: [id])
    class      Class      @relation(fields: [classId], references: [id])
    @@map("conn_student_class")
}

model CONN_Employee_ExamTest {
    id         Int @id @default(autoincrement())
    employeeId Int
    examTestId Int

    employee Employee @relation(fields: [employeeId], references: [id])
    examTest ExamTest @relation(fields: [examTestId], references: [id])
    @@map("conn_employee_examtest")
}

model CONN_Employee_Class {
    id         Int @id @default(autoincrement())
    employeeId Int
    classId    Int

    employee Employee @relation(fields: [employeeId], references: [id])
    class    Class    @relation(fields: [classId], references: [id])
    @@map("conn_employee_class")
}

model FullReportMonthly {
    id      Int  @id @default(autoincrement())
    month Int
    year Int

    totalRevenue  BigInt   @default(0)
    newStudent  Int @default(0)
    classInProgress  Int @default(0)
    openingExam  Int @default(0)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    revenueDaily    RevenueReportDaily[]
}

model RevenueReportDaily {
    id      Int  @id @default(autoincrement())
    rpMonthId   Int
    dayInMonth  Int

    totalRevenue  BigInt   @default(0)
    
    monthReport FullReportMonthly @relation(fields: [rpMonthId], references: [id]) 
}

// Khi Student đăng kí 1 khóa học thì
//      + Tạo 1 BillDetail
//      + Tạo 1 Connection gắn với khóa học và student
//      + Liên kết BillDetail với Connection qua connection.billDetailId
// Khi Student thanh toán n BillDetail thì
//      + Tạo 1 Payment đại diện cho lần thanh toán
//      + Nếu thành công thì Liên kết BillDetail với Payment qua BillDetail.paymentId
//      + Nếu chưa thành công thì vẫn để BillDetail.paymentId = null

// Xem danh sách hóa đơn của student:
//      + Lấy các BillDetail CNN_Student_*** bằng studentId
//      + Nếu chưa thanh toán thì BillDetail.payment = null
//      + Lấy trạng thái thanh toán qua BillDetail.payment.status
